import{i as e,C as t}from"./vendor-DHU54Zka.js";const r=/_key\s*==\s*['"](.*)['"]/;function n(e){if(!Array.isArray(e))throw new Error("Path is not an array");return e.reduce((e,t,n)=>{const o=typeof t;if("number"===o)return`${e}[${t}]`;if("string"===o)return`${e}${0===n?"":"."}${t}`;if(function(e){return"string"==typeof e?r.test(e.trim()):"object"==typeof e&&"_key"in e}(t)&&t._key)return`${e}[_key=="${t._key}"]`;if(Array.isArray(t)){const[r,n]=t;return`${e}[${r}:${n}]`}throw new Error(`Unsupported path segment \`${JSON.stringify(t)}\``)},"")}const o={"\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","'":"\\'","\\":"\\\\"},i={"\\f":"\f","\\n":"\n","\\r":"\r","\\t":"\t","\\'":"'","\\\\":"\\"};function s(e){const t=[],r=/\['(.*?)'\]|\[(\d+)\]|\[\?\(@\._key=='(.*?)'\)\]/g;let n;for(;null!==(n=r.exec(e));){if(void 0!==n[1]){const e=n[1].replace(/\\(\\|f|n|r|t|')/g,e=>i[e]);t.push(e);continue}if(void 0===n[2]){if(void 0!==n[3]){const e=n[3].replace(/\\(\\')/g,e=>i[e]);t.push({_key:e,_index:-1});continue}}else t.push(parseInt(n[2],10))}return t}function a(e){return e.map(e=>{if("string"==typeof e||"number"==typeof e)return e;if(""!==e._key)return{_key:e._key};if(-1!==e._index)return e._index;throw new Error(`invalid segment:${JSON.stringify(e)}`)})}function u(e,t){if(!t?.mappings)return;const r=function(e){return`$${e.map(e=>"string"==typeof e?`['${e.replace(/[\f\n\r\t'\\]/g,e=>o[e])}']`:"number"==typeof e?`[${e}]`:""!==e._key?`[?(@._key=='${e._key.replace(/['\\]/g,e=>o[e])}')]`:`[${e._index}]`).join("")}`}(e.map(e=>{if("string"==typeof e||"number"==typeof e)return e;if(-1!==e._index)return e._index;throw new Error(`invalid segment:${JSON.stringify(e)}`)}));if(void 0!==t.mappings[r])return{mapping:t.mappings[r],matchedPath:r,pathSuffix:""};const n=Object.entries(t.mappings).filter(([e])=>r.startsWith(e)).sort(([e],[t])=>t.length-e.length);if(0==n.length)return;const[i,s]=n[0];return{mapping:s,matchedPath:i,pathSuffix:r.substring(i.length)}}function c(t,r,n=[]){if(function(e){return null!==e&&Array.isArray(e)}(t))return t.map((t,o)=>{if(e(t)){const e=t._key;if("string"==typeof e)return c(t,r,n.concat({_key:e,_index:o}))}return c(t,r,n.concat(o))});if(e(t)){if("block"===t._type||"span"===t._type){const e={...t};return"block"===t._type?e.children=c(t.children,r,n.concat("children")):"span"===t._type&&(e.text=c(t.text,r,n.concat("text"))),e}return Object.fromEntries(Object.entries(t).map(([e,t])=>[e,c(t,r,n.concat(e))]))}return r(t,n)}function p(e,t,r){return c(e,(e,n)=>{if("string"!=typeof e)return e;const o=u(n,t);if(!o)return e;const{mapping:i,matchedPath:a}=o;if("value"!==i.type||"documentValue"!==i.source.type)return e;const c=t.documents[i.source.document],p=t.paths[i.source.path],l=s(a),f=s(p).concat(n.slice(l.length));return r({sourcePath:f,sourceDocument:c,resultPath:n,value:e})})}const l=".",f=`drafts${l}`,d=`versions${l}`;function h(e){return e.startsWith(f)}function g(e){return e.startsWith(d)}function y(e){const{baseUrl:t,workspace:r="default",tool:o="default",id:i,type:s,path:u,projectId:c,dataset:p}=e;if(!t)throw new Error("baseUrl is required");if(!u)throw new Error("path is required");if(!i)throw new Error("id is required");if("/"!==t&&t.endsWith("/"))throw new Error("baseUrl must not end with a slash");const d="default"===r?void 0:r,y="default"===o?void 0:o,m=function(e){return g(e)?e.split(l).slice(2).join(l):h(e)?e.slice(f.length):e}(i),$=Array.isArray(u)?n(a(u)):u,_=new URLSearchParams({baseUrl:t,id:m,type:s,path:$});if(d&&_.set("workspace",d),y&&_.set("tool",y),c&&_.set("projectId",c),p&&_.set("dataset",p),function(e){return!h(e)&&!g(e)}(i))_.set("perspective","published");else if(g(i)){const e=function(e){if(!g(e))return;const[t,r,...n]=e.split(l);return r}(i);_.set("perspective",e)}const b=["/"===t?"":t];d&&b.push(d);const k=["mode=presentation",`id=${m}`,`type=${s}`,`path=${encodeURIComponent($)}`];return y&&k.push(`tool=${y}`),b.push("intent","edit",`${k.join(";")}?${_}`),b.join("/")}const m=({sourcePath:e,resultPath:t,value:r})=>{if(/^\d{4}-\d{2}-\d{2}/.test(n=r)&&Date.parse(n)||function(e){try{new URL(e,e.startsWith("/")?"https://acme.com":void 0)}catch{return!1}return!0}(r))return!1;var n;const o=e.at(-1);return!("slug"===e.at(-2)&&"current"===o||"string"==typeof o&&(o.startsWith("_")||o.endsWith("Id"))||e.some(e=>"meta"===e||"metadata"===e||"openGraph"===e||"seo"===e)||_(e)||_(t)||"string"==typeof o&&$.has(o))},$=new Set(["color","colour","currency","email","format","gid","hex","href","hsl","hsla","icon","id","index","key","language","layout","link","linkAction","locale","lqip","page","path","ref","rgb","rgba","route","secret","slug","status","tag","template","theme","type","textTheme","unit","url","username","variant","website"]);function _(e){return e.some(e=>"string"==typeof e&&null!==e.match(/type/i))}function b(e,n,o){const{filter:i,logger:s,enabled:a}=o;if(!a){const t="config.enabled must be true, don't call this function otherwise";throw s?.error?.(`[@sanity/client]: ${t}`,{result:e,resultSourceMap:n,config:o}),new TypeError(t)}if(!n)return s?.error?.("[@sanity/client]: Missing Content Source Map from response body",{result:e,resultSourceMap:n,config:o}),e;if(!o.studioUrl){const t="config.studioUrl must be defined";throw s?.error?.(`[@sanity/client]: ${t}`,{result:e,resultSourceMap:n,config:o}),new TypeError(t)}const u={encoded:[],skipped:[]},c=p(e,n,({sourcePath:e,sourceDocument:r,resultPath:n,value:a})=>{if(!1===("function"==typeof i?i({sourcePath:e,resultPath:n,filterDefault:m,sourceDocument:r,value:a}):m({sourcePath:e,resultPath:n,value:a})))return s&&u.skipped.push({path:k(e),value:`${a.slice(0,20)}${a.length>20?"...":""}`,length:a.length}),a;s&&u.encoded.push({path:k(e),value:`${a.slice(0,20)}${a.length>20?"...":""}`,length:a.length});const{baseUrl:c,workspace:p,tool:l}=function(e){let t="string"==typeof e?e:e.baseUrl;return"/"!==t&&(t=t.replace(/\/$/,"")),"string"==typeof e?{baseUrl:t}:{...e,baseUrl:t}}("function"==typeof o.studioUrl?o.studioUrl(r):o.studioUrl);if(!c)return a;const{_id:f,_type:d,_projectId:h,_dataset:g}=r;return t(a,{origin:"sanity.io",href:y({baseUrl:c,workspace:p,tool:l,id:f,type:d,path:e,...!o.omitCrossDatasetReferenceData&&{dataset:g,projectId:h}})},!1)});if(s){const e=u.skipped.length,t=u.encoded.length;if((e||t)&&((s?.groupCollapsed||s.log)?.("[@sanity/client]: Encoding source map into result"),s.log?.(`[@sanity/client]: Paths encoded: ${u.encoded.length}, skipped: ${u.skipped.length}`)),u.encoded.length>0&&(s?.log?.("[@sanity/client]: Table of encoded paths"),(s?.table||s.log)?.(u.encoded)),u.skipped.length>0){const e=new Set;for(const{path:t}of u.skipped)e.add(t.replace(r,"0").replace(/\[\d+\]/g,"[]"));s?.log?.("[@sanity/client]: List of skipped paths",[...e.values()])}(e||t)&&s?.groupEnd?.()}return c}function k(e){return n(a(e))}var w=Object.freeze({__proto__:null,stegaEncodeSourceMap:b});export{p as encodeIntoResult,b as stegaEncodeSourceMap,w as stegaEncodeSourceMap$1};
